<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/jquery.cookie/1.4.1/jquery.cookie.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/cupertino/jquery-ui.css">


<h1>Hello, {{username}}!</h1>
<h2>Please submit your tokens for <input type="text" id="date" value="{{date}}" /></h2>

<table id="tokens">
</table>

<button id="submit">throw these potatoes</button>

<script type="text/javascript">

$( document ).ready(function() {
    var datepicker = $('input[type=text]#date').datepicker({dateFormat: 'yy-mm-dd'});
    var makeCellFromLayoutCell = function(layoutCell) {
        if (layoutCell.type == 'text') {
            return $('<td>' + layoutCell.value + '</td>');
        }
        else if (layoutCell.type == 'heading') {
            return $('<th>' + layoutCell.value + '</th>');
        }
        else if (layoutCell.type == 'bucket') {
            return $('<td><input type="text" id="' + layoutCell.value + '" /></td>');
        }
    };
    var makeRowFromLayoutRow = function(layoutRow) {
        var row = $('<tr>');
        layoutRow.forEach(function(entry) {
            row.append(makeCellFromLayoutCell(entry));
        });
        return row;
    };
    var loadTable = function() {
        var table = $('table#tokens');
        table.empty();
        $.ajax({
            url: '/api/' + $.cookie('github_login') + '/tokens/' + $('input[type=text]#date').val(),
            success: function(data, status) {
                         data.template.layout.forEach(function(entry) {
                             table.append(makeRowFromLayoutRow(entry));
                         });
                         data.tokens.forEach(function(entry) {
                             $('input[type=text]#' + entry.bucket).val(entry.tokens);
                         });
                     },
            error: function() {
                $.ajax({
                    url: '/api/' + $.cookie('github_login') + '/templates/' + $('input[type=text]#date').val(),
                    success: function(data, status) {
                        data.layout.forEach(function(entry) {
                            table.append(makeRowFromLayoutRow(entry));
                        });
                    }
                });
          }
        });
    };
    loadTable();
    datepicker.on('change', function() {
        loadTable();
    });
    $('button#submit').click(function() {
        var buckets = [];
        $('table#tokens').find('input[type=text]').each(function(_, element) {
            if ($(element).val() != "") {
                buckets.push({'bucket': element.id, 'tokens': parseInt($(element).val(), 10)});
            }
        });
        var date = $('input[type=text]#date').val();

        $.ajax({
          url: '/api/' + $.cookie('github_login') + '/tokens/' + date,
          method: 'post',
          data: JSON.stringify({'buckets': buckets}),
          contentType: 'application/json',
          beforeSend: function(request) {
                          request.setRequestHeader('Github-Login', $.cookie('github_login'));
                          request.setRequestHeader('Github-Auth-Token', $.cookie('github_auth_token'));
          },
          success: function(data, status) {
                       window.location.href = '/success';
          },
          error: function(data, status) {
                     alert('Submission failed due to computer reasons.');
          }
        });
    });
});

</script>
